<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardiaIA - Plataforma de Análisis Clínico Inteligente</title>
    
    <!-- Core Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- PDF Handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    
    <!-- Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- UI Enhancement -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cardia_ia.css') }}">

    <!-- Custom Styles -->
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --error: #dc2626;
            --success: #059669;
            --warning: #f59e0b;
        }

        .lab-upload-zone {
            border: 2px dashed #e5e7eb;
            transition: all 0.3s ease;
        }

        .lab-upload-zone.drag-over {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
        }

        .risk-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
        }

        .risk-badge.muy-alto { background: var(--error); color: white; }
        .risk-badge.alto { background: var(--warning); color: white; }
        .risk-badge.moderado { background: #fbbf24; color: black; }
        .risk-badge.bajo { background: var(--success); color: white; }
    </style>
</head>
<body class="text-text-main">

    <div class="main-grid">
        <main class="form-panel">
            <header class="mb-6 flex justify-between items-center">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="w-10 h-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                        </svg>
                        <h1 class="text-3xl font-extrabold text-gray-900">CardiaIA</h1>
                    </div>
                    <p class="text-text-subtle">Plataforma de Análisis Clínico Inteligente para RCV</p>
                </div>
                <div class="flex gap-2">
                    <button id="high-contrast-toggle" class="text-gray-500 hover:text-primary p-2 rounded-full" title="Alternar contraste alto">
                        <i class="fas fa-adjust"></i>
                    </button>
                    <button id="open-history-btn" class="text-gray-500 hover:text-primary p-2 rounded-full" title="Historial de pacientes">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
            </header>

            <form id="clinical-form" class="space-y-6 flex-grow overflow-y-auto pr-4 -mr-4">
                <section>
                    <h2 class="text-xl font-bold mb-4 border-l-4 border-primary pl-3">Datos del Paciente</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                        <div>
                            <label for="nombre" class="font-medium text-sm mb-1 block">Nombre Completo <span class="text-red-500">*</span></label>
                            <input type="text" id="nombre" name="nombre" class="input-field" required>
                        </div>
                        <div>
                            <label for="edad" class="font-medium text-sm mb-1 block">Edad (años) <span class="text-red-500">*</span></label>
                            <input type="number" id="edad" name="edad" class="input-field" min="1" required>
                        </div>
                        <div>
                            <label for="sexo" class="font-medium text-sm mb-1 block">Sexo <span class="text-red-500">*</span></label>
                            <select id="sexo" name="sexo" class="input-field" required>
                                <option value="m">Masculino</option>
                                <option value="f">Femenino</option>
                            </select>
                        </div>
                         <div>
                            <label for="peso" class="font-medium text-sm mb-1 block">Peso (kg) <span class="text-red-500">*</span></label>
                            <input type="number" id="peso" name="peso" step="0.1" class="input-field" required>
                        </div>
                         <div>
                            <label for="talla" class="font-medium text-sm mb-1 block">Talla (cm)</label>
                            <input type="number" id="talla" name="talla" class="input-field">
                        </div>
                        <div>
                             <label for="imc" class="font-medium text-sm mb-1 block">Índice de Masa Corporal (IMC)</label>
                             <input type="text" id="imc" name="imc" class="input-field bg-gray-100" readonly>
                        </div>
                        <div>
                            <label for="per_abd" class="font-medium text-sm mb-1 block">Perímetro Abdominal (cm)</label>
                            <input type="number" id="per_abd" name="per_abd" class="input-field">
                        </div>
                    </div>
                </section>
                
                <section>
                    <h2 class="text-xl font-bold mb-4 border-l-4 border-primary pl-3">Presión Arterial</h2>
                    <div id="pa-container" class="space-y-2">
                        </div>
                    <button type="button" id="add-pa-btn" class="text-sm font-medium text-primary hover:text-primary-light mt-2" aria-label="Añadir medición de presión arterial"><i class="fas fa-plus mr-1"></i> Añadir medición</button>
                </section>

                <section>
                    <h2 class="text-xl font-bold mb-4 border-l-4 border-primary pl-3">Diagnósticos y Condiciones</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="font-medium text-sm mb-2 block">Diagnósticos Principales <span class="text-red-500">*</span></label>
                            <div id="main-diagnostics" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <label class="checkbox-card"><input type="checkbox" name="diagnostico" value="HTA" class="h-5 w-5 mr-4"><span class="content">Hipertensión (HTA)</span></label>
                                <label class="checkbox-card"><input type="checkbox" name="diagnostico" value="DM" id="dm-checkbox" class="h-5 w-5 mr-4"><span class="content">Diabetes (DM)</span></label>
                                <label class="checkbox-card"><input type="checkbox" name="diagnostico" value="ERC" id="erc-checkbox" class="h-5 w-5 mr-4"><div class="flex items-center content"><span>ERC</span><div id="erc-alert-icon" class="tooltip ml-2 hidden"><svg class="w-5 h-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg><span class="tooltip-text">ERC Estadio ≥3 o Albuminuria >30 mg/g.</span></div></div></label>
                            </div>
                        </div>
                        <div id="duracion-dm-container" class="hidden">
                             <label for="duracion_dm" class="font-medium text-sm mb-1 block">Duración DM (años)</label>
                             <input type="number" id="duracion_dm" name="duracion_dm" class="input-field w-full md:w-1/2" min="0">
                        </div>
                        <div>
                            <label class="font-medium text-sm mb-2 block">Condiciones Adicionales</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="checkbox-card"><input type="checkbox" id="ecv_establecida" name="ecv_establecida" class="h-5 w-5 mr-4"><span class="content">Enf. Cardiovascular Establecida</span></label>
                                <label class="checkbox-card"><input type="checkbox" id="tabaquismo" name="tabaquismo" class="h-5 w-5 mr-4"><span class="content">Tabaquismo Activo</span></label>
                                <label class="checkbox-card"><input type="checkbox" id="cond_socioeconomicas" name="cond_socioeconomicas" class="h-5 w-5 mr-4"><div class="flex items-center content"><span>Cond. Socioeconómicas Adversas</span></div></label>
                                <div class="flex items-center">
                                    <label class="checkbox-card flex-grow"><input type="checkbox" id="fragil" name="fragil" class="h-5 w-5 mr-4" disabled><span class="content">Paciente Frágil</span></label>
                                    <button type="button" id="eval-fragilidad-btn" class="ml-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded-lg transition-colors" aria-label="Evaluar fragilidad">Evaluar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section id="predialysis-section" class="hidden">
                    <h2 class="text-xl font-bold mb-4 border-l-4 border-yellow-500 pl-3 text-yellow-700">Programa de Prediálisis</h2>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <p class="font-medium text-sm mb-2">La TFG del paciente es ≤ 20 ml/min. Indique el estado en el programa de prediálisis:</p>
                        <div class="flex gap-4">
                            <label class="flex items-center"><input type="radio" name="predialysis_status" value="primera_vez" class="h-4 w-4 mr-2"> Primera Vez</label>
                            <label class="flex items-center"><input type="radio" name="predialysis_status" value="en_seguimiento" class="h-4 w-4 mr-2"> En Seguimiento</label>
                        </div>
                    </div>
                </section>

                <section>
                    <h2 class="text-xl font-bold mb-4 border-l-4 border-primary pl-3">Adherencia y Acceso</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                        <div>
                            <label for="adherencia" class="font-medium text-sm mb-1 block">Adherencia al Tratamiento</label>
                            <select id="adherencia" name="adherencia" class="input-field">
                                <option value="buena">Buena</option>
                                <option value="regular">Regular</option>
                                <option value="mala">Mala</option>
                            </select>
                        </div>
                        <div class="flex items-center pt-6">
                             <label class="checkbox-card flex-grow"><input type="checkbox" id="barreras_acceso" name="barreras_acceso" class="h-5 w-5 mr-4"><span class="content">Barreras de Acceso (EPS/Farmacia)</span></label>
                        </div>
                    </div>
                 </section>

                <section>
                    <h2 class="text-xl font-bold mb-4 border-l-4 border-primary pl-3">Tratamiento Farmacológico</h2>
                    <div id="medicamentos-container" class="space-y-2"></div>
                    <button type="button" id="add-medicamento-btn" class="text-sm font-medium text-primary hover:text-primary-light mt-2" aria-label="Añadir medicamento"><i class="fas fa-plus mr-1"></i> Añadir medicamento</button>
                    <div class="mt-4">
                        <p class="text-xs text-gray-500 mb-2">Añadir Fármacos Comunes:</p>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="quick-med-btn" data-med="Atorvastatina" data-dosis="40mg" data-freq="Cada noche">Atorvastatina 40mg</button>
                            <button type="button" class="quick-med-btn" data-med="Losartán" data-dosis="50mg" data-freq="Cada 12h">Losartán 50mg</button>
                            <button type="button" class="quick-med-btn" data-med="Metformina" data-dosis="850mg" data-freq="Cada 12h">Metformina 850mg</button>
                            <button type="button" class="quick-med-btn" data-med="AAS" data-dosis="100mg" data-freq="Cada 24h">AAS 100mg</button>
                        </div>
                    </div>
                </section>

                <section>
                    <h2 class="text-xl font-bold mb-4 border-l-4 border-primary pl-3">Laboratorios</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 mb-4">
                         <div>
                            <label for="creatinina" class="font-medium text-sm mb-1 block">Creatinina Sérica (mg/dL) <span class="text-red-500">*</span></label>
                            <div class="flex gap-2">
                                <input type="number" id="creatinina" name="creatinina" step="0.01" class="input-field" required>
                                <input type="date" id="creatinina_date" name="creatinina_date" class="input-field">
                            </div>
                        </div>
                        <div>
                            <label class="font-medium text-sm mb-1 block">TFG (Cockcroft-Gault)</label>
                            <input type="text" id="tfg-display" class="input-field bg-gray-100" readonly>
                        </div>
                    </div>
                    <label class="flex items-center text-sm my-4 cursor-pointer"><input type="checkbox" id="manual-lab-toggle" class="h-4 w-4 rounded mr-2 accent-primary"> Ingresar otros laboratorios manualmente</label>
                    <div id="lab-upload-container" class="p-4 rounded-lg border border-dashed file-drop-area">
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                            <p class="mt-2 text-sm text-gray-600">Arrastra y suelta archivos (.pdf, .txt)</p>
                            <p class="text-xs text-gray-500 mt-1">o</p>
                            <button type="button" onclick="document.getElementById('lab-file-upload').click()" class="mt-2 text-sm font-semibold text-primary hover:underline">Selecciona archivos</button>
                            <input type="file" id="lab-file-upload" accept=".txt,.pdf" class="hidden" multiple/>
                        </div>
                    </div>
                    <div id="file-loader" class="mt-2 hidden items-center gap-2 text-sm text-primary"><div class="loader !w-5 !h-5"></div><span>Analizando archivos...</span></div>
                    <div id="manual-lab-inputs" class="hidden space-y-4 mt-4">
                        </div>
                    <div id="loaded-labs-container" class="mt-4 space-y-2">
                        </div>
                </section>

            </form>
             <div class="mt-auto pt-4 border-t border-gray-200">
                <button id="generate-report-btn" type="submit" form="clinical-form" class="w-full bg-primary hover:bg-primary-light text-white font-bold py-4 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-300 flex items-center justify-center gap-3">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    Generar Informe Clínico con IA
                </button>
            </div>
        </main>

        <aside class="report-panel">
            <div id="risk-assessment-panel" class="p-5 rounded-xl mb-4 transition-all duration-500 bg-gray-200">
                <h3 class="font-bold text-lg text-center text-gray-600 mb-3">Clasificación de Riesgo del Paciente</h3>
                <div id="risk-level-indicator" class="text-center font-extrabold text-3xl py-4 rounded-lg text-white transition-all duration-500 bg-gray-400">INCOMPLETO</div>
                <div id="risk-factors-summary" class="mt-4 text-sm text-gray-600 space-y-1"><p>Complete los datos para calcular el riesgo.</p></div>
            </div>
            <div id="goals-preview-panel" class="p-5 rounded-xl mb-6 transition-all duration-500 bg-white shadow-sm">
                 <h3 class="font-bold text-lg text-center text-gray-600 mb-4">Metas Terapéuticas Clave</h3>
                 <div id="goals-preview-content" class="space-y-3">
                    <p class="text-center text-sm text-gray-400">Los datos de metas aparecerán aquí.</p>
                 </div>
            </div>
            <div id="report-container" class="h-full">
                <div id="report-placeholder" class="text-center text-gray-500 pt-10">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=cardiaia&backgroundColor=4C6EF5" alt="CardiaIA Logo" class="w-24 h-24 mx-auto mb-4">
                    <h2 class="text-xl font-medium">Esperando datos del paciente</h2>
                    <p class="max-w-xs mx-auto">El informe generado por la IA aparecerá aquí.</p>
                </div>
                <div id="report-loader" class="text-center text-gray-500 pt-16 hidden"><div class="loader mx-auto"></div><p class="mt-4">Analizando datos y generando informe...</p></div>
                <div id="report-output-container" class="hidden h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold">Informe Clínico</h2>
                        <div>
                            <button id="print-report-btn" class="text-gray-500 hover:text-primary px-2 py-1 rounded-md" aria-label="Imprimir informe"><i class="fas fa-print"></i></button>
                            <button id="copy-report-btn" class="text-gray-500 hover:text-primary px-2 py-1 rounded-md" aria-label="Copiar informe"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <div id="report-output" class="flex-grow bg-white p-6 rounded-xl shadow-sm overflow-y-auto"></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Modals -->
    <div id="fragility-modal" class="modal-backdrop">
        <div class="modal-content max-w-lg">
            <div class="modal-header">
                <h3 class="text-xl font-bold">Evaluación de Fragilidad</h3>
                <button id="close-fragility-modal" class="modal-close" aria-label="Cerrar modal">×</button>
            </div>
            <div class="modal-body">
                <p class="mb-4">Evaluación según criterios de Fried (Síndrome de Fragilidad):</p>
                <div id="fried-criteria" class="space-y-3 mb-4">
                    <label class="checkbox-card"><input type="checkbox" name="perdida_peso" class="h-5 w-5 mr-4"><span class="content">Pérdida de Peso No Intencional</span></label>
                    <label class="checkbox-card"><input type="checkbox" name="fatiga" class="h-5 w-5 mr-4"><span class="content">Fatiga/Agotamiento</span></label>
                    <label class="checkbox-card"><input type="checkbox" name="debilidad" class="h-5 w-5 mr-4"><span class="content">Debilidad Muscular</span></label>
                    <label class="checkbox-card"><input type="checkbox" name="lentitud" class="h-5 w-5 mr-4"><span class="content">Lentitud en la Marcha</span></label>
                    <label class="checkbox-card"><input type="checkbox" name="baja_actividad" class="h-5 w-5 mr-4"><span class="content">Baja Actividad Física</span></label>
                </div>
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div>
                            <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-200">
                                No Frágil
                            </span>
                        </div>
                        <div>
                            <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-red-600 bg-red-200">
                                Frágil
                            </span>
                        </div>
                    </div>
                    <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200">
                        <div id="frailty-marker" class="absolute top-7 w-2 h-2 bg-blue-600 rounded-full transform -translate-x-1/2" style="left: 0%"></div>
                        <div class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-green-500" style="width: 60%"></div>
                        <div class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-500" style="width: 40%"></div>
                    </div>
                </div>
                <div class="p-4 rounded-lg bg-gray-100 text-center">
                    <p class="text-sm font-medium mb-1">Estado del Paciente:</p>
                    <p id="frailty-status" class="text-2xl font-bold">No Frágil</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="bg-primary hover:bg-primary-light text-white font-bold py-2 px-4 rounded" onclick="document.getElementById('close-fragility-modal').click()">
                    Aceptar
                </button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="modal-backdrop">
        <div class="modal-content max-w-md">
            <div class="modal-header">
                <h3 id="alert-title" class="text-xl font-bold">Alerta</h3>
                <button id="close-alert-modal" class="modal-close" aria-label="Cerrar modal">×</button>
            </div>
            <div class="modal-body">
                <p id="alert-message"></p>
            </div>
            <div class="modal-footer">
                <button class="bg-primary hover:bg-primary-light text-white font-bold py-2 px-4 rounded" onclick="document.getElementById('close-alert-modal').click()">
                    Aceptar
                </button>
            </div>
        </div>
    </div>
    <div id="history-modal" class="modal-backdrop">
        <div class="modal-content max-w-3xl">
            <div class="modal-header">
                <h3 class="text-xl font-bold">Historial de Pacientes</h3>
                <button id="close-history-modal" class="modal-close" aria-label="Cerrar modal">×</button>
            </div>
            <div class="modal-body">
                <div id="patient-history-list" class="space-y-2">
                    <p class="text-sm text-gray-500">No hay pacientes guardados.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded" onclick="document.getElementById('close-history-modal').click()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/cardia_ia.js') }}"></script>
</body>
</html>


