#!/usr/bin/env python3
"""
ğŸš” ERC INSIGHT POLICE WATCHDOG - PARTE 1 DEMO
Sistema autÃ³nomo de monitoreo, integridad y enforcement para Flask App

VERSIÃ“N SIMPLIFICADA PARA DEMOSTRACIÃ“N
Author: ERC Insight Team
Version: 1.0.0
"""

import os
import sys
import json
import time
import logging
import traceback
from datetime import datetime, timedelta
from threading import Thread, Lock, Event
from pathlib import Path
from typing import Dict, List, Optional, Any
from dataclasses import dataclass, asdict
from enum import Enum
import sqlite3
import hashlib

# Importaciones opcionales
try:
    import psutil
    PSUTIL_AVAILABLE = True
except ImportError:
    PSUTIL_AVAILABLE = False
    print("âš ï¸ psutil no disponible - algunas mÃ©tricas de sistema estarÃ¡n deshabilitadas")

try:
    from apscheduler.schedulers.background import BackgroundScheduler
    from apscheduler.triggers.interval import IntervalTrigger
    SCHEDULER_AVAILABLE = True
except ImportError:
    SCHEDULER_AVAILABLE = False
    print("âš ï¸ APScheduler no disponible - usando timer bÃ¡sico")

# ============================================================================
# ğŸ”§ CONFIGURACIÃ“N GLOBAL DEL SISTEMA POLICÃA
# ============================================================================

class AlertLevel(Enum):
    """Niveles de alertas del sistema"""
    INFO = "INFO"
    WARNING = "WARNING" 
    CRITICAL = "CRITICAL"
    EMERGENCY = "EMERGENCY"

class RuleCategory(Enum):
    """CategorÃ­as de reglas mÃ©dicas"""
    TFG_CALCULATION = "tfg_calculation"
    ERC_CLASSIFICATION = "erc_classification"
    LAB_VALIDITY = "lab_validity"
    THERAPEUTIC_GOALS = "therapeutic_goals"
    DATA_INTEGRITY = "data_integrity"
    PERFORMANCE = "performance"
    SECURITY = "security"

@dataclass
class MonitoringConfig:
    """ConfiguraciÃ³n principal del sistema de monitoreo"""
    # Rutas y archivos
    app_root: str = r"c:\Users\brandon\Desktop\ERC"
    log_file: str = "logs/erc_police.log"
    db_file: str = "erc_police.db"
    config_file: str = "config/police_config.json"
    
    # Intervalos de monitoreo (segundos)
    file_check_interval: int = 30
    performance_check_interval: int = 60
    health_check_interval: int = 120
    medical_rules_check_interval: int = 300
    
    # LÃ­mites y umbrales
    max_cpu_percent: float = 85.0
    max_memory_percent: float = 80.0
    max_response_time: float = 3.0
    min_disk_space_gb: float = 1.0
    
    # Archivos crÃ­ticos a monitorear
    critical_files: List[str] = None
    
    def __post_init__(self):
        if self.critical_files is None:
            self.critical_files = [
                "app/__init__.py",
                "app/logic/patient_eval.py", 
                "app/logic/advanced_patient_eval.py",
                "run.py",
                "wsgi.py",
                "config.py"
            ]

@dataclass
class HealthStatus:
    """Estado de salud del sistema"""
    timestamp: datetime
    cpu_percent: float = 0.0
    memory_percent: float = 0.0
    disk_space_gb: float = 0.0
    active_connections: int = 0
    response_time: float = 0.0
    errors_last_hour: int = 0
    status: str = "HEALTHY"

# ============================================================================
# ğŸ—„ï¸ SISTEMA DE BASE DE DATOS LOCAL
# ============================================================================

class PoliceDatabase:
    """Base de datos local para el sistema policÃ­a"""
    
    def __init__(self, db_path: str):
        self.db_path = db_path
        self.lock = Lock()
        self._init_database()
    
    def _init_database(self):
        """Inicializa las tablas de la base de datos"""
        try:
            os.makedirs(os.path.dirname(self.db_path), exist_ok=True)
        except:
            pass
            
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            
            # Tabla de eventos de monitoreo
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS monitoring_events (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    timestamp TEXT NOT NULL,
                    event_type TEXT NOT NULL,
                    severity TEXT NOT NULL,
                    description TEXT NOT NULL,
                    details TEXT,
                    resolved BOOLEAN DEFAULT FALSE,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            """)
            
            # Tabla de mÃ©tricas de salud
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS health_metrics (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    timestamp TEXT NOT NULL,
                    cpu_percent REAL,
                    memory_percent REAL,
                    disk_space_gb REAL,
                    response_time REAL,
                    status TEXT,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                )
            """)
            
            conn.commit()
            print("âœ… Base de datos inicializada correctamente")
    
    def log_event(self, event_type: str, severity: AlertLevel, description: str, details: Dict = None):
        """Registra un evento de monitoreo"""
        with self.lock:
            try:
                with sqlite3.connect(self.db_path) as conn:
                    cursor = conn.cursor()
                    cursor.execute("""
                        INSERT INTO monitoring_events 
                        (timestamp, event_type, severity, description, details)
                        VALUES (?, ?, ?, ?, ?)
                    """, (
                        datetime.now().isoformat(),
                        event_type,
                        severity.value,
                        description,
                        json.dumps(details) if details else None
                    ))
                    conn.commit()
                    print(f"ğŸ“ Evento registrado: {severity.value} - {description}")
            except Exception as e:
                print(f"âŒ Error al registrar evento: {e}")

# ============================================================================
# ğŸ” SISTEMA DE LOGGING BÃSICO
# ============================================================================

class ERCPoliceLogger:
    """Logger bÃ¡sico para el sistema policÃ­a"""
    
    def __init__(self, config: MonitoringConfig):
        self.config = config
        self._setup_logging()
        self.db = PoliceDatabase(os.path.join(config.app_root, config.db_file))
    
    def _setup_logging(self):
        """Configura el sistema de logging"""
        log_path = os.path.join(self.config.app_root, self.config.log_file)
        try:
            os.makedirs(os.path.dirname(log_path), exist_ok=True)
        except:
            pass
        
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler(log_path),
                logging.StreamHandler(sys.stdout)
            ]
        )
        
        self.logger = logging.getLogger("ERC_POLICE")
        print("âœ… Sistema de logging configurado")
    
    def info(self, message: str, **kwargs):
        self.logger.info(f"{message} {kwargs}")
    
    def warning(self, message: str, **kwargs):
        self.logger.warning(f"{message} {kwargs}")
        self.db.log_event("WARNING", AlertLevel.WARNING, message, kwargs)
    
    def critical(self, message: str, **kwargs):
        self.logger.critical(f"{message} {kwargs}")
        self.db.log_event("CRITICAL", AlertLevel.CRITICAL, message, kwargs)

# ============================================================================
# ğŸ¯ CLASE PRINCIPAL DEL SISTEMA POLICÃA
# ============================================================================

class ERCPoliceWatchdog:
    """
    Sistema principal de monitoreo y enforcement para ERC Insight
    VERSIÃ“N DEMO PARA PARTE 1
    """
    
    def __init__(self, config: MonitoringConfig = None):
        self.config = config or MonitoringConfig()
        self.logger = ERCPoliceLogger(self.config)
        self.db = self.logger.db
        
        # Estado del sistema
        self.is_running = False
        self.stop_event = Event()
        
        # Cache de archivos monitoreados
        self.file_hashes: Dict[str, str] = {}
        
        self.logger.info("ğŸš” ERC Police Watchdog inicializado", config=asdict(self.config))
        print("âœ… Watchdog inicializado exitosamente")
    
    def start(self):
        """Inicia el sistema de monitoreo"""
        if self.is_running:
            self.logger.warning("El sistema ya estÃ¡ ejecutÃ¡ndose")
            return
        
        self.logger.info("ğŸš€ Iniciando ERC Police Watchdog...")
        print("ğŸš€ Iniciando ERC Police Watchdog...")
        
        try:
            self.is_running = True
            
            # Inicializar hashes de archivos
            self._initialize_file_monitoring()
            
            # Simular mÃ©tricas de sistema
            self._demo_system_check()
            
            self.logger.info("âœ… ERC Police Watchdog iniciado exitosamente")
            print("âœ… ERC Police Watchdog iniciado exitosamente")
            
        except Exception as e:
            self.logger.critical("âŒ Error al iniciar el sistema", error=str(e))
            print(f"âŒ Error al iniciar el sistema: {e}")
            self.stop()
    
    def stop(self):
        """Detiene el sistema de monitoreo"""
        if not self.is_running:
            return
        
        self.logger.info("ğŸ›‘ Deteniendo ERC Police Watchdog...")
        print("ğŸ›‘ Deteniendo ERC Police Watchdog...")
        
        try:
            self.is_running = False
            self.stop_event.set()
            
            self.logger.info("âœ… ERC Police Watchdog detenido exitosamente")
            print("âœ… ERC Police Watchdog detenido exitosamente")
            
        except Exception as e:
            self.logger.critical("âŒ Error al detener el sistema", error=str(e))
            print(f"âŒ Error al detener el sistema: {e}")
    
    def _initialize_file_monitoring(self):
        """Inicializa el monitoreo de archivos crÃ­ticos"""
        print("ğŸ“ Inicializando monitoreo de archivos crÃ­ticos...")
        
        for file_path in self.config.critical_files:
            full_path = os.path.join(self.config.app_root, file_path)
            if os.path.exists(full_path):
                file_hash = self._calculate_file_hash(full_path)
                self.file_hashes[file_path] = file_hash
                self.logger.info("ğŸ“ Archivo aÃ±adido al monitoreo", file=file_path, hash=file_hash[:8])
                print(f"  âœ… {file_path} (hash: {file_hash[:8]}...)")
            else:
                print(f"  âš ï¸ {file_path} (no encontrado)")
    
    def _calculate_file_hash(self, file_path: str) -> str:
        """Calcula el hash MD5 de un archivo"""
        hash_md5 = hashlib.md5()
        try:
            with open(file_path, "rb") as f:
                for chunk in iter(lambda: f.read(4096), b""):
                    hash_md5.update(chunk)
            return hash_md5.hexdigest()
        except Exception as e:
            self.logger.warning("Error calculando hash", file=file_path, error=str(e))
            return ""
    
    def _demo_system_check(self):
        """DemostraciÃ³n de chequeos del sistema"""
        print("ğŸ¥ Ejecutando chequeos de demostraciÃ³n...")
        
        # Simular mÃ©tricas bÃ¡sicas
        if PSUTIL_AVAILABLE:
            cpu_percent = psutil.cpu_percent()
            memory = psutil.virtual_memory()
            disk = psutil.disk_usage('/')
            
            print(f"  ğŸ’» CPU: {cpu_percent:.1f}%")
            print(f"  ğŸ§  Memoria: {memory.percent:.1f}%")
            print(f"  ğŸ’¾ Disco: {disk.percent:.1f}%")
            
            # Simular alerta si los valores son altos
            if cpu_percent > self.config.max_cpu_percent:
                self.logger.warning("Alto uso de CPU detectado", cpu=cpu_percent)
            
        else:
            print("  âš ï¸ MÃ©tricas de sistema no disponibles (psutil no instalado)")
        
        # Verificar archivos crÃ­ticos
        print("ğŸ” Verificando integridad de archivos crÃ­ticos...")
        modified_files = 0
        
        for file_path, old_hash in self.file_hashes.items():
            full_path = os.path.join(self.config.app_root, file_path)
            if os.path.exists(full_path):
                new_hash = self._calculate_file_hash(full_path)
                if new_hash != old_hash:
                    modified_files += 1
                    self.logger.warning("Archivo modificado detectado", 
                                      file=file_path, 
                                      old_hash=old_hash[:8], 
                                      new_hash=new_hash[:8])
                    print(f"  ğŸ”„ {file_path} - MODIFICADO")
                else:
                    print(f"  âœ… {file_path} - OK")
        
        if modified_files == 0:
            print("  âœ… Todos los archivos crÃ­ticos estÃ¡n Ã­ntegros")
        
        # Simular chequeo de reglas mÃ©dicas
        print("âš•ï¸ Simulando chequeo de reglas mÃ©dicas ERC...")
        self._demo_medical_rules_check()
    
    def _demo_medical_rules_check(self):
        """DemostraciÃ³n de chequeos de reglas mÃ©dicas"""
        
        # Simular validaciÃ³n de cÃ¡lculo de TFG
        test_cases = [
            {"edad": 65, "peso": 70, "creatinina": 1.2, "sexo": "f"},
            {"edad": 45, "peso": 80, "creatinina": 0.9, "sexo": "m"},
            {"edad": 70, "peso": 65, "creatinina": 1.8, "sexo": "f"}
        ]
        
        for i, case in enumerate(test_cases, 1):
            # Simular cÃ¡lculo TFG (fÃ³rmula Cockcroft-Gault)
            factor_sexo = 0.85 if case["sexo"] == "f" else 1.0
            tfg = ((140 - case["edad"]) * case["peso"] * factor_sexo) / (72 * case["creatinina"])
            
            # Determinar etapa ERC
            if tfg >= 90: etapa = "G1"
            elif tfg >= 60: etapa = "G2"  
            elif tfg >= 45: etapa = "G3a"
            elif tfg >= 30: etapa = "G3b"
            elif tfg >= 15: etapa = "G4"
            else: etapa = "G5"
            
            print(f"  ğŸ‘¤ Caso {i}: TFG={tfg:.1f} ml/min â†’ Etapa {etapa}")
            
            # Simular validaciÃ³n de regla mÃ©dica
            if tfg < 15:  # Etapa G5
                self.logger.critical("Paciente en etapa G5 detectado - Requiere atenciÃ³n urgente",
                                   tfg=tfg, etapa=etapa, case=case)
                print(f"    ğŸš¨ ALERTA CRÃTICA: Paciente requiere diÃ¡lisis")
            elif tfg < 30:  # Etapa G4
                self.logger.warning("Paciente en etapa G4 detectado - PreparaciÃ³n para TRS",
                                  tfg=tfg, etapa=etapa)
                print(f"    âš ï¸ ALERTA: Preparar para terapia de reemplazo renal")


# ============================================================================
# ğŸ® PUNTO DE ENTRADA PRINCIPAL
# ============================================================================

def main():
    """FunciÃ³n principal para ejecutar el watchdog - DEMO PARTE 1"""
    print("="*80)
    print("ğŸš” ERC INSIGHT POLICE WATCHDOG - PARTE 1 DEMO")
    print("="*80)
    print("âœ… Imports y configuraciÃ³n listos")
    print("âœ… Sistema de base de datos inicializado")
    print("âœ… Logger bÃ¡sico configurado") 
    print("âœ… Clase principal ERCPoliceWatchdog creada")
    print("="*80)
    print("ğŸ”„ Ejecutando demostraciÃ³n de funcionalidad base...")
    print()
    
    # Crear instancia de configuraciÃ³n
    config = MonitoringConfig()
    
    # Crear el watchdog
    watchdog = ERCPoliceWatchdog(config)
    
    try:
        # Ejecutar demo
        watchdog.start()
        print()
        print("ğŸ¯ DEMO COMPLETADA - El sistema base estÃ¡ funcionando")
        print("ğŸ“Š Revisa el archivo 'logs/erc_police.log' para ver los logs detallados")
        print("ğŸ—„ï¸ Revisa el archivo 'erc_police.db' para ver los eventos registrados")
        print()
        print("â³ El sistema continuarÃ¡ ejecutÃ¡ndose por 10 segundos...")
        
        # Simular ejecuciÃ³n por 10 segundos
        for i in range(10, 0, -1):
            print(f"  â° {i} segundos restantes...", end='\r')
            time.sleep(1)
        
        print("\n")
        watchdog.stop()
        
        print("="*80)
        print("ğŸ‰ PARTE 1 COMPLETADA EXITOSAMENTE")
        print("ğŸ“‹ PRÃ“XIMO PASO: Implementar PARTE 2 (Funciones de chequeo y enforcement)")
        print("ğŸ”„ LUEGO: Implementar PARTE 3 (Alertas, manejo de errores y tests)")
        print("="*80)
            
    except KeyboardInterrupt:
        print("\nğŸ›‘ Deteniendo sistema...")
        watchdog.stop()
        print("âœ… Sistema detenido exitosamente")
    except Exception as e:
        print(f"\nâŒ Error durante la ejecuciÃ³n: {e}")
        watchdog.stop()

if __name__ == "__main__":
    main()
